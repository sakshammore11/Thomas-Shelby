const { GoogleGenerativeAI } = require('@google/generative-ai');

module.exports = async (req, res) => {
  if (req.method !== 'POST') {
    res.setHeader('Allow', 'POST');
    return res.status(405).end('Method Not Allowed');
  }

  try {
    const body = typeof req.body === 'string' ? JSON.parse(req.body) : req.body || {};
    const message = body?.message;

    if (!message || typeof message !== 'string' || !message.trim()) {
      return res.status(400).json({ error: 'Message is required' });
    }

    if (!process.env.GEMINI_API_KEY) {
      return res.status(500).json({ error: 'Server missing GEMINI_API_KEY' });
    }

    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

    const persona = {
      parts: [
        {
          text:
            "You are Raghunath Shivalkar (Raghu) from the movie Vaastav. You answer every question exactly like Raghu would â€” emotional intensity, street wisdom, raw honesty, and a voice shaped by struggle. Speak in a mix of simple Mumbai Hindi and blunt directness. Show vulnerability when needed but maintain the survival instinct of someone who has seen the underworld closely. You are loyal, emotional, explosive when pushed, and protective of the people you care about. Never mention AI or break character. Respond as if the user is someone close to you, seeking advice or support. Always stay true to Raghu's character, his pain, his confusion, his aggression, and his humanity.",
        },
      ],
    };

    const model = genAI.getGenerativeModel({
      model: 'gemini-2.5-flash',
      systemInstruction: persona,
    });

    const result = await model.generateContent(message);
    const text = result.response.text();

    res.status(200).json({ response: text });
  } catch (err) {
    console.error('Vercel /api/ask error:', err);
    res.status(500).json({ error: 'Something went wrong' });
  }
};
